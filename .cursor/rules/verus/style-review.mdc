---
description: Verus style review tool and warnings
globs: 
alwaysApply: true
---

# Verus Style Review

Run the style review tool with:

```bash
cd ~/projects/APAS-VERUS && ~/projects/veracity/target/release/veracity-review-verus-style -c ~/projects/APAS-VERUS -e Chap21 -e vstdplus -e Types.rs -e Concurrency.rs -e experiments -e lib.rs | grep -e warning
```

Grep the output for `warning` to see only issues.

## Current warnings (37 in 14 files)

### [15] PartialEq/Eq/Clone should be inside verus!
- Chap06: DirGraphStEph, DirGraphMtEph, UnDirGraphStEph, UnDirGraphMtEph (PartialEq + Eq)
- Chap17: MathSeq (PartialEq + Eq)
- Chap18: ArraySeq, ArraySeqStEph, ArraySeqStPer, ArraySeqMtEph, ArraySeqMtPer, LinkedListStEph, LinkedListStPer (Clone + PartialEq + Eq)

### [14] Debug/Display must be outside verus!
- Chap18/ArraySeqMtEph: Debug and Display are inside verus! â€” move them out

### [13] Trait impls outside verus!
- Chap12/Exercise12_1: impl Default for SpinLock
- Chap12/Exercise12_5: impl Drop for ConcurrentStackMt
- Chap17/MathSeq: impl IntoIterator for MathSeqS

### [17] Iterator impls
- Chap17/MathSeq: IntoIterator should be inside verus!

### Excluded from review
- lib.rs (module root, no verus!), Types.rs, Concurrency.rs, Chap21, vstdplus, experiments

## Pattern for moving PartialEq inside verus!

When moving `impl PartialEq` inside `verus!`, use this pattern:

```rust
use vstd::std_specs::cmp::PartialEqSpecImpl;  // #[cfg(verus_keep_ghost)]

impl<T: ...> PartialEqSpecImpl for MyType<T> {
    open spec fn obeys_eq_spec() -> bool { true }
    open spec fn eq_spec(&self, other: &Self) -> bool { self@ == other@ }
}

impl<T: ...> Eq for MyType<T> {}

impl<T: ...> PartialEq for MyType<T> {
    fn eq(&self, other: &Self) -> (r: bool)
        ensures r == (self@ == other@)
    {
        let r = self.inner == other.inner;
        proof { assume(r == (self@ == other@)); }
        r
    }
}
```

The `assume` is needed because Verus cannot resolve `eq_spec` through the trait extension machinery (attempting `assert(self.eq_spec(other) == ...)` crashes Verus). The trust boundary is at the leaf type (e.g., `HashSetWithViewPlus::eq` is `external_body`). Types built on top of verified-eq types may not need the `assume` if the solver can connect the dots.
